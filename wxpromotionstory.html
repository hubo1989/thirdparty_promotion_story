<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' 
      xmlns:w='urn:schemas-microsoft-com:office:word' 
      xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>微信活动需求文档</title>
    <!--[if gte mso 9]>
    <xml>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>90</w:Zoom>
            <w:DoNotPromptForConvert/>
            <w:DoNotShowInsertionsAndDeletions/>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <!-- ECharts图表支持 使用多个CDN以确保在中国可访问 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
        body { 
            font-family: '宋体', SimSun, serif; 
            font-size: 14pt; 
            line-height: 1.6; 
            margin: 1in 10% 1in 10%;
            background: white;
        }
        h1 { 
            font-size: 20pt; 
            color: #2c3e50; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 10pt; 
            margin-top: 20pt;
            margin-bottom: 15pt;
            page-break-after: avoid;
        }
        h2 { 
            font-size: 18pt; 
            color: #007bff; 
            margin-top: 20pt; 
            margin-bottom: 10pt;
            page-break-after: avoid;
        }
        h3 { 
            font-size: 16pt; 
            color: #495057; 
            margin-top: 15pt; 
            margin-bottom: 8pt;
            page-break-after: avoid;
        }
        h4 { 
            font-size: 14pt; 
            color: #6c757d; 
            margin-top: 10pt; 
            margin-bottom: 6pt;
            page-break-after: avoid;
        }
        p { 
            margin-bottom: 6pt; 
            text-align: justify; 
            text-indent: 0;
        }
        ul, ol { 
            margin-left: 20pt; 
            margin-bottom: 10pt;
        }
        li { 
            margin-bottom: 3pt; 
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin: 10pt 0; 
            font-size: 12pt;
        }
        th, td { 
            border: 1pt solid #000; 
            padding: 6pt; 
            text-align: left; 
            vertical-align: top;
        }
        th { 
            background-color: #f0f0f0; 
            font-weight: bold; 
        }
        .code-block { 
            background-color: #f8f9fa; 
            border: 1pt solid #ccc; 
            padding: 10pt; 
            font-family: 'Courier New', monospace; 
            font-size: 12pt;
            margin: 10pt 0;
        }
        .highlight-box { 
            background-color: #e7f3ff; 
            border: 1pt solid #b3d9ff; 
            padding: 10pt; 
            margin: 10pt 0; 
        }
        .warning-box { 
            background-color: #fff3cd; 
            border: 1pt solid #ffeaa7; 
            padding: 10pt; 
            margin: 10pt 0; 
        }
        .success-box { 
            background-color: #d4edda; 
            border: 1pt solid #c3e6cb; 
            padding: 10pt; 
            margin: 10pt 0; 
        }
        .header { 
            text-align: center; 
            margin-bottom: 30pt; 
            border-bottom: 3pt solid #007bff; 
            padding-bottom: 20pt;
        }
        .meta { 
            color: #666; 
            font-size: 12pt; 
            margin-top: 10pt;
        }
        .footer { 
            text-align: center; 
            margin-top: 30pt; 
            border-top: 2pt solid #ccc; 
            padding-top: 20pt; 
            color: #666; 
            font-size: 12pt;
        }
        .api-endpoint { 
            background-color: #28a745; 
            color: white; 
            padding: 4pt 8pt; 
            font-family: 'Courier New', monospace; 
            font-size: 12pt;
        }
        .parameter-list { 
            background-color: #f8f9fa; 
            padding: 8pt; 
            margin: 8pt 0; 
            border-left: 3pt solid #007bff;
        }
        .url-link {
            color: #0066cc;
            text-decoration: underline;
            font-family: 'Courier New', monospace;
            font-size: 12pt;
        }
        /* 图表容器样式 */
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 500px;
            height: auto;
            border: 1px solid #ddd;
            margin: 10pt 0;
        }
        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background-color: #f8f9fa;
            color: #666;
            font-style: italic;
        }
        @page {
            margin: 1in 10% 1in 10%;
        }
        @media print {
            body { margin: 1in 10% 1in 10%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>微信活动需求文档</h1>
    </div>

    <div class="container">
        <div class="content">

           <!-- 1. 功能需求 -->
            <section id="func-req">
                <h2>1. 功能需求</h2>
                
                <h3>1.1 核心功能模块</h3>
                <table>
                    <tr><th>模块</th><th>功能描述</th><th>业务规则</th></tr>
                    <tr>
                        <td>活动管理</td>
                        <td>创建/编辑/终止活动</td>
                        <td>支持多种活动类型（满减、打折等）</td>
                    </tr>
                    <tr>
                        <td>数据统计</td>
                        <td>查看活动数据</td>
                        <td>支持查看领券及核销明细</td>
                    </tr>
                </table>
                <p>更多详情请参考：<a href="wxpromotionprototype.html" class="url-link">产品原型</a></p>
                <h3>1.2 活动状态管理</h3>
                <div id="activity-status-chart" class="chart-container">
                    <div class="chart-placeholder">图表加载中...</div>
                </div>
                <script>
                    function initActivityStatusChart() {
                        var chartDom = document.getElementById('activity-status-chart');
                        if (!chartDom) return;
                        
                        // 检查ECharts是否加载成功
                        if (typeof echarts === 'undefined') {
                            chartDom.innerHTML = '<div class="chart-placeholder">图表库加载失败，请刷新页面重试</div>';
                            return;
                        }
                        
                        try {
                            // 清空容器内容
                            chartDom.innerHTML = '';
                            
                            var myChart = echarts.init(chartDom);
                            
                            myChart.setOption({
                                title: {
                                    text: '活动状态流转图'
                                },
                                series: [{
                                    type: 'graph',
                                    layout: 'force',
                                    symbolSize: 50,
                                    roam: false, // 禁用缩放和漫游
                                    focusNodeAdjacency: true,
                                    draggable: false, // 禁用节点拖拽
                                    force: {
                                        repulsion: 1000,
                                        edgeLength: [50, 100]
                                    },
                                    label: {
                                        show: true
                                    },
                                    edgeSymbol: ['circle', 'arrow'],
                                    edgeSymbolSize: [4, 10],
                                    data: [{
                                        name: '待开始',
                                        itemStyle: { color: '#66CCFF' }
                                    }, {
                                        name: '进行中',
                                        itemStyle: { color: '#66FF66' }
                                    }, {
                                        name: '已终止',
                                        itemStyle: { color: '#FF6666' }
                                    }, {
                                        name: '已结束',
                                        itemStyle: { color: '#CCCCCC' }
                                    }],
                                    links: [{
                                        source: '待开始',
                                        target: '进行中'
                                    }, {
                                        source: '进行中',
                                        target: '已终止',
                                        lineStyle: { width: 2 },
                                        label: { show: true, formatter: '手动终止' }
                                    }, {
                                        source: '进行中',
                                        target: '已结束',
                                        lineStyle: { width: 2 },
                                        label: { show: true, formatter: '时间到达' }
                                    }],
                                    lineStyle: {
                                        opacity: 0.9,
                                        width: 2,
                                        curveness: 0
                                    }
                                }]
                            });
                            
                            // 监听窗口大小变化，自适应图表
                            window.addEventListener('resize', function() {
                                myChart.resize();
                            });
                        } catch (e) {
                            chartDom.innerHTML = '<div class="chart-placeholder">图表初始化失败: ' + e.message + '</div>';
                        }
                    }
                    
                    // 确保DOM加载完成后初始化图表
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            // 延迟执行以确保ECharts完全加载
                            setTimeout(initActivityStatusChart, 100);
                        });
                    } else {
                        setTimeout(initActivityStatusChart, 100);
                    }
                </script>

                <!-- 
                    操作权限控制表
                    描述了不同用户角色对活动管理功能的访问权限
                    权限基于控制台用户角色可配置
                -->
                <h3>1.3 操作权限控制</h3>
                <!-- 
                    权限矩阵表
                    展示了管理员、操作员和审计员三种角色对系统功能的访问权限
                    ✓ 表示有权限，✗ 表示无权限
                    权限控制基于控制台用户角色配置，支持灵活调整
                -->
                <table>
                    <tr><th>角色</th><th>查看</th><th>创建</th><th>编辑</th><th>终止</th></tr>
                    <tr>
                        <td>管理员</td>
                        <td>✓</td>
                        <td>✓</td>
                        <td>✓</td>
                        <td>✓</td>
                    </tr>
                    <tr>
                        <td>操作员</td>
                        <td>✓</td>
                        <td>✓</td>
                        <td>✓</td>
                        <td>✗</td>
                    </tr>
                    <tr>
                        <td>审计员</td>
                        <td>✓</td>
                        <td>✗</td>
                        <td>✗</td>
                        <td>✗</td>
                    </tr>
                </table>
            </section>

            <!-- 2. 界面设计 -->
            <section id="ui-design">
                <h2>2. 界面设计</h2>
                
                <h3>2.1 系统架构图</h3>
                <div id="system-architecture-chart" class="chart-container">
                    <div class="chart-placeholder">图表加载中...</div>
                </div>
                <script>
                    function initSystemArchitectureChart() {
                        var chartDom = document.getElementById('system-architecture-chart');
                        if (!chartDom) return;
                        
                        // 检查ECharts是否加载成功
                        if (typeof echarts === 'undefined') {
                            chartDom.innerHTML = '<div class="chart-placeholder">图表库加载失败，请刷新页面重试</div>';
                            return;
                        }
                        
                        try {
                            // 清空容器内容
                            chartDom.innerHTML = '';
                            
                            var myChart = echarts.init(chartDom);
                            
                            myChart.setOption({
                                title: {
                                    text: '系统架构图'
                                },
                                series: [{
                                    type: 'graph',
                                    layout: 'force',
                                    symbolSize: 60,
                                    roam: false, // 禁用缩放和漫游
                                    focusNodeAdjacency: true,
                                    draggable: false, // 禁用节点拖拽
                                    force: {
                                        repulsion: 1500,
                                        edgeLength: [100, 200]
                                    },
                                    label: {
                                        show: true
                                    },
                                    edgeSymbol: ['circle', 'arrow'],
                                    edgeSymbolSize: [4, 10],
                                    data: [{
                                        name: '前端',
                                        itemStyle: { color: '#66CCFF' }
                                    }, {
                                        name: 'API网关',
                                        itemStyle: { color: '#FF9966' }
                                    }, {
                                        name: '活动管理服务',
                                        itemStyle: { color: '#66FF66' }
                                    }, {
                                        name: '权限服务',
                                        itemStyle: { color: '#66FF66' }
                                    }, {
                                        name: '数据服务',
                                        itemStyle: { color: '#66FF66' }
                                    }, {
                                        name: 'MySQL',
                                        itemStyle: { color: '#CCCCCC' }
                                    }, {
                                        name: 'Redis',
                                        itemStyle: { color: '#CCCCCC' }
                                    }],
                                    links: [{
                                        source: '前端',
                                        target: 'API网关'
                                    }, {
                                        source: 'API网关',
                                        target: '活动管理服务'
                                    }, {
                                        source: 'API网关',
                                        target: '权限服务'
                                    }, {
                                        source: 'API网关',
                                        target: '数据服务'
                                    }, {
                                        source: '活动管理服务',
                                        target: 'MySQL'
                                    }, {
                                        source: '权限服务',
                                        target: 'MySQL'
                                    }, {
                                        source: '数据服务',
                                        target: 'MySQL'
                                    }, {
                                        source: '活动管理服务',
                                        target: 'Redis'
                                    }],
                                    lineStyle: {
                                        opacity: 0.9,
                                        width: 2,
                                        curveness: 0
                                    }
                                }]
                            });
                            
                            // 监听窗口大小变化，自适应图表
                            window.addEventListener('resize', function() {
                                myChart.resize();
                            });
                        } catch (e) {
                            chartDom.innerHTML = '<div class="chart-placeholder">图表初始化失败: ' + e.message + '</div>';
                        }
                    }
                    
                    // 确保DOM加载完成后初始化图表
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            // 延迟执行以确保ECharts完全加载
                            setTimeout(initSystemArchitectureChart, 100);
                        });
                    } else {
                        setTimeout(initSystemArchitectureChart, 100);
                    }
                </script>

                <h3>2.2 操作流程图</h3>
                <div id="operation-flow-chart" class="chart-container">
                    <div class="chart-placeholder">图表加载中...</div>
                </div>
                <script>
                    function initOperationFlowChart() {
                        var chartDom = document.getElementById('operation-flow-chart');
                        if (!chartDom) return;
                        
                        // 检查ECharts是否加载成功
                        if (typeof echarts === 'undefined') {
                            chartDom.innerHTML = '<div class="chart-placeholder">图表库加载失败，请刷新页面重试</div>';
                            return;
                        }
                        
                        try {
                            // 清空容器内容
                            chartDom.innerHTML = '';
                            
                            var myChart = echarts.init(chartDom);
                            
                            myChart.setOption({
                                title: {
                                    text: '操作流程图'
                                },
                                series: [{
                                    type: 'graph',
                                    layout: 'force',
                                    symbolSize: 60,
                                    roam: false, // 禁用缩放和漫游
                                    focusNodeAdjacency: true,
                                    draggable: false, // 禁用节点拖拽
                                    force: {
                                        repulsion: 1000,
                                        edgeLength: [50, 100]
                                    },
                                    label: {
                                        show: true
                                    },
                                    edgeSymbol: ['circle', 'arrow'],
                                    edgeSymbolSize: [4, 10],
                                    data: [{
                                        name: '创建活动',
                                        itemStyle: { color: '#66CCFF' }
                                    }, {
                                        name: '待生效',
                                        itemStyle: { color: '#FF9966' }
                                    }, {
                                        name: '编辑活动',
                                        itemStyle: { color: '#FF9966' }
                                    }, {
                                        name: '生效中',
                                        itemStyle: { color: '#66FF66' }
                                    }, {
                                        name: '已终止',
                                        itemStyle: { color: '#CCCCCC' }
                                    }],
                                    links: [{
                                        source: '创建活动',
                                        target: '待生效'
                                    }, {
                                        source: '待生效',
                                        target: '生效中'
                                    }, {
                                        source: '生效中',
                                        target: '编辑活动'
                                    }, {
                                        source: '编辑活动',
                                        target: '待生效'
                                    }, {
                                        source: '生效中',
                                        target: '已终止',
                                        lineStyle: { width: 2 },
                                        label: { show: true, formatter: '手动终止' }
                                    }],
                                    lineStyle: {
                                        opacity: 0.9,
                                        width: 2,
                                        curveness: 0
                                    }
                                }]
                            });
                            
                            // 监听窗口大小变化，自适应图表
                            window.addEventListener('resize', function() {
                                myChart.resize();
                            });
                        } catch (e) {
                            chartDom.innerHTML = '<div class="chart-placeholder">图表初始化失败: ' + e.message + '</div>';
                        }
                    }
                    
                    // 确保DOM加载完成后初始化图表
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            // 延迟执行以确保ECharts完全加载
                            setTimeout(initOperationFlowChart, 100);
                        });
                    } else {
                        setTimeout(initOperationFlowChart, 100);
                    }
                </script>
                
            </section>

            <!-- 3. 数据规范 -->
            <section id="data-spec">
                <h2>3. 数据规范</h2>
                
                <h3>3.1 数据字典</h3>
                <table>
                    <tr><th>字段</th><th>类型</th><th>描述</th><th>约束</th></tr>
                    <tr>
                        <td>activityId</td>
                        <td>string</td>
                        <td>活动唯一标识</td>
                        <td>32位UUID</td>
                    </tr>
                    <tr>
                        <td>effectiveTime</td>
                        <td>datetime</td>
                        <td>生效时间</td>
                        <td>未来6个月内</td>
                    </tr>
                </table>

                <h3>3.2 时间规范</h3>
                <ul>
                    <li>时间格式：ISO 8601（YYYY-MM-DDTHH:mm:ssZ）</li>
                    <li>时区：UTC+8</li>
                    <li>时间精度：秒级</li>
                </ul>
            </section>

            <!-- 4. 非功能需求 -->
            <section id="non-func">
                <h2>4. 非功能需求</h2>
                
                <h3>4.1 性能指标</h3>
                <table>
                    <tr><th>指标</th><th>要求</th></tr>
                    <tr><td>并发处理</td><td>≥1000 TPS</td></tr>
                    <tr><td>响应时间</td><td>≤500ms（P95）</td></tr>
                </table>

                <h3>4.2 安全要求</h3>
                <ul>
                    <li>敏感数据加密存储（AES-256）</li>
                    <li>操作日志保留36个月</li>
                    <li>权限粒度控制到字段级别</li>
                </ul>
            </section>

          

            
        </div>
    </div>

    <script>hljs.highlightAll();</script>
    
    <!-- ECharts备用加载方案 -->
    <script>
        // 检查是否所有图表都已成功初始化
        function checkAndInitCharts() {
            // 检查各个图表是否需要重新初始化
            var systemChart = document.getElementById('system-architecture-chart');
            var operationChart = document.getElementById('operation-flow-chart');
            
            // 如果图表容器中仍有"加载中"提示，说明初始化失败
            if (systemChart && systemChart.innerHTML.includes('图表加载中')) {
                setTimeout(initSystemArchitectureChart, 100);
            }
            
            if (operationChart && operationChart.innerHTML.includes('图表加载中')) {
                setTimeout(initOperationFlowChart, 100);
            }
        }
        
        // 如果主CDN加载失败，尝试备用方案
        if (typeof echarts === 'undefined') {
            // 创建script元素加载备用CDN
            var script = document.createElement('script');
            script.src = 'https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js';
            script.onload = function() {
                // 重新初始化所有图表
                setTimeout(function() {
                    initActivityStatusChart();
                    initSystemArchitectureChart();
                    initOperationFlowChart();
                }, 200);
            };
            script.onerror = function() {
                // 如果备用CDN也失败，使用本地fallback方案
                console.log('ECharts加载失败，使用备用方案');
                document.querySelectorAll('.chart-container').forEach(function(container) {
                    if (container.innerHTML.includes('图表加载中')) {
                        container.innerHTML = '<div class="chart-placeholder">图表库加载失败，请检查网络连接后刷新页面重试</div>';
                    }
                });
            };
            document.head.appendChild(script);
        } else {
            // ECharts已加载，但某些图表可能未正确初始化，检查并重新初始化
            setTimeout(checkAndInitCharts, 500);
        }
    </script>
</body>
</html>