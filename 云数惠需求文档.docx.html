<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' 
      xmlns:w='urn:schemas-microsoft-com:office:word' 
      xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>云数惠第三方微信优惠券服务接入需求文档</title>
    <!--[if gte mso 9]>
    <xml>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>90</w:Zoom>
            <w:DoNotPromptForConvert/>
            <w:DoNotShowInsertionsAndDeletions/>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
        body { 
            font-family: '宋体', SimSun, serif; 
            font-size: 12pt; 
            line-height: 1.6; 
            margin: 1in;
            background: white;
        }
        h1 { 
            font-size: 18pt; 
            color: #2c3e50; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 10pt; 
            margin-top: 20pt;
            margin-bottom: 15pt;
            page-break-after: avoid;
        }
        h2 { 
            font-size: 16pt; 
            color: #007bff; 
            margin-top: 20pt; 
            margin-bottom: 10pt;
            page-break-after: avoid;
        }
        h3 { 
            font-size: 14pt; 
            color: #495057; 
            margin-top: 15pt; 
            margin-bottom: 8pt;
            page-break-after: avoid;
        }
        h4 { 
            font-size: 12pt; 
            color: #6c757d; 
            margin-top: 10pt; 
            margin-bottom: 6pt;
            page-break-after: avoid;
        }
        p { 
            margin-bottom: 6pt; 
            text-align: justify; 
            text-indent: 0;
        }
        ul, ol { 
            margin-left: 20pt; 
            margin-bottom: 10pt;
        }
        li { 
            margin-bottom: 3pt; 
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin: 10pt 0; 
            font-size: 10pt;
        }
        th, td { 
            border: 1pt solid #000; 
            padding: 6pt; 
            text-align: left; 
            vertical-align: top;
        }
        th { 
            background-color: #f0f0f0; 
            font-weight: bold; 
        }
        .code-block { 
            background-color: #f8f9fa; 
            border: 1pt solid #ccc; 
            padding: 10pt; 
            font-family: 'Courier New', monospace; 
            font-size: 10pt;
            margin: 10pt 0;
        }
        .highlight-box { 
            background-color: #e7f3ff; 
            border: 1pt solid #b3d9ff; 
            padding: 10pt; 
            margin: 10pt 0; 
        }
        .warning-box { 
            background-color: #fff3cd; 
            border: 1pt solid #ffeaa7; 
            padding: 10pt; 
            margin: 10pt 0; 
        }
        .success-box { 
            background-color: #d4edda; 
            border: 1pt solid #c3e6cb; 
            padding: 10pt; 
            margin: 10pt 0; 
        }
        .header { 
            text-align: center; 
            margin-bottom: 30pt; 
            border-bottom: 3pt solid #007bff; 
            padding-bottom: 20pt;
        }
        .meta { 
            color: #666; 
            font-size: 10pt; 
            margin-top: 10pt;
        }
        .footer { 
            text-align: center; 
            margin-top: 30pt; 
            border-top: 2pt solid #ccc; 
            padding-top: 20pt; 
            color: #666; 
            font-size: 10pt;
        }
        .api-endpoint { 
            background-color: #28a745; 
            color: white; 
            padding: 4pt 8pt; 
            font-family: 'Courier New', monospace; 
            font-size: 10pt;
        }
        .parameter-list { 
            background-color: #f8f9fa; 
            padding: 8pt; 
            margin: 8pt 0; 
            border-left: 3pt solid #007bff;
        }
        @page {
            margin: 1in;
        }
        @media print {
            body { margin: 0; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>云数惠第三方微信优惠券服务接入需求文档</h1>
        <div class="meta">
            <strong>文档版本：</strong>V1.0 &nbsp;&nbsp;|&nbsp;&nbsp;
            <strong>创建日期：</strong>2024年 &nbsp;&nbsp;|&nbsp;&nbsp;
            <strong>修订日期：</strong>2024年
        </div>
    </div>

    <h1>1. 项目概述</h1>
    
    <h3>1.1 项目背景</h3>
    <p>接入云数惠第三方微信优惠券服务商，封装其发券、回调接口，为合作银行提供统一的优惠券发放服务，并在管理平台展示相关数据。</p>

    <h3>1.2 项目目标</h3>
    <div class="highlight-box">
        <ul>
            <li>与云数惠API对接，实现优惠券发放功能</li>
            <li>封装标准化接口供合作银行调用</li>
            <li>提供数据统计和查询功能</li>
            <li>建立完善的回调处理机制</li>
        </ul>
    </div>

    <h1>2. 业务需求</h1>
    
    <h3>2.1 合作银行情况</h3>
    <ul>
        <li><strong>银行数量</strong>：不限制合作银行数量，支持几十到上百家银行接入</li>
        <li><strong>接入方式</strong>：统一标准化接口，支持批量接入</li>
    </ul>

    <h3>2.2 优惠券类型</h3>
    <div class="success-box">
        <p><strong>支持多种优惠券类型：</strong></p>
        <ul>
            <li>满减券</li>
            <li>折扣券</li>
            <li>代金券</li>
        </ul>
    </div>

    <h3>2.3 发券场景</h3>
    <ul>
        <li>银行自主搭建发券场景</li>
        <li>我方提供转接服务，不涉及具体业务场景</li>
    </ul>

    <h3>2.4 业务规模</h3>
    <table>
        <tr>
            <th>指标</th>
            <th>数值</th>
            <th>说明</th>
        </tr>
        <tr>
            <td>日常发券量</td>
            <td>5,000张/天</td>
            <td>正常业务量</td>
        </tr>
        <tr>
            <td>峰值发券量</td>
            <td>20,000张/天</td>
            <td>活动期间峰值</td>
        </tr>
        <tr>
            <td>银行数量</td>
            <td>几十到上百家</td>
            <td>支持大规模接入</td>
        </tr>
    </table>

    <h1>3. 系统架构</h1>
    
    <h3>3.1 系统组成</h3>
    <div class="highlight-box">
        <ul>
            <li><strong>云数惠接入层</strong>：对接云数惠API</li>
            <li><strong>业务封装层</strong>：封装标准化接口</li>
            <li><strong>数据存储层</strong>：存储发放和核销数据</li>
            <li><strong>管理平台层</strong>：数据展示和权限管理</li>
            <li><strong>银行营销平台</strong>：银行端数据查询</li>
        </ul>
    </div>

    <h3>3.2 业务流程</h3>
    
    <h4>3.2.1 发券流程</h4>
    <div class="code-block">
        <strong>用户 → 接入方系统 → 银行营销系统 → 我方系统 → 云数惠 → 微信</strong>
    </div>

    <h4>3.2.2 详细流程步骤</h4>
    <ol>
        <li><strong>用户进入</strong>：用户通过接入方系统进入</li>
        <li><strong>H5页面获取actcode</strong>：actcode为AES加密的二次code+活动编码</li>
        <li><strong>验证code有效性</strong>：
            <div class="parameter-list">
                <strong>参数：</strong>code、活动编码、奖励会员<br>
                <strong>返回：</strong>确认会员有效、流水号、用户信息
            </div>
        </li>
        <li><strong>权益发放</strong>：调用云数惠发放接口</li>
        <li><strong>发放结果通知</strong>：接收云数惠回调通知</li>
        <li><strong>返回结果</strong>：返回发放成功结果</li>
        <li><strong>查询发放结果</strong>：支持发放结果查询</li>
    </ol>

    <h1>4. 技术需求</h1>
    
    <h3>4.1 云数惠API接口</h3>
    <div class="warning-box">
        <p><strong>加密方式：</strong>RSA2048</p>
    </div>
    <p><strong>接口列表：</strong></p>
    <ul>
        <li>发放授权确认</li>
        <li>发放优惠券</li>
        <li>查询发放结果</li>
        <li>发放回调通知</li>
        <li>核销回调通知</li>
    </ul>

    <h3>4.2 回调机制</h3>
    <table>
        <tr>
            <th>回调类型</th>
            <th>回调事件</th>
            <th>说明</th>
        </tr>
        <tr>
            <td rowspan="2">发放结果回调</td>
            <td>发放成功</td>
            <td>优惠券发放成功通知</td>
        </tr>
        <tr>
            <td>发放失败</td>
            <td>优惠券发放失败通知</td>
        </tr>
        <tr>
            <td rowspan="2">核销结果回调</td>
            <td>核销成功</td>
            <td>优惠券核销成功通知</td>
        </tr>
        <tr>
            <td>核销失败</td>
            <td>优惠券核销失败通知</td>
        </tr>
    </table>

    <h3>4.3 数据存储要求</h3>
    <div class="success-box">
        <ul>
            <li><strong>按活动ID存储</strong>：发放成功数量统计</li>
            <li><strong>核销明细</strong>：详细核销记录</li>
            <li><strong>发放明细</strong>：详细发放记录</li>
            <li><strong>查询支持</strong>：供合作银行查询相关数据</li>
        </ul>
    </div>

    <h1>5. 功能需求</h1>
    
    <h3>5.1 核心功能模块</h3>
    
    <h4>5.1.1 发券服务模块</h4>
    <ul>
        <li><strong>接口封装</strong>：封装云数惠发券接口</li>
        <li><strong>参数验证</strong>：验证发券请求参数</li>
        <li><strong>权限校验</strong>：校验银行发券权限</li>
        <li><strong>流水记录</strong>：记录发券流水信息</li>
    </ul>

    <h4>5.1.2 回调处理模块</h4>
    <ul>
        <li><strong>回调接收</strong>：接收云数惠回调通知</li>
        <li><strong>数据解析</strong>：解析回调数据</li>
        <li><strong>状态更新</strong>：更新发券/核销状态</li>
        <li><strong>通知转发</strong>：向银行转发回调通知</li>
    </ul>

    <h4>5.1.3 查询服务模块</h4>
    <ul>
        <li><strong>发放结果查询</strong>：查询发券结果</li>
        <li><strong>核销结果查询</strong>：查询核销结果</li>
        <li><strong>统计数据查询</strong>：查询发放统计数据</li>
    </ul>

    <h4>5.1.4 数据统计模块</h4>
    <ul>
        <li><strong>发放统计</strong>：按活动ID统计发放数量</li>
        <li><strong>核销统计</strong>：统计核销数量和金额</li>
        <li><strong>银行维度统计</strong>：按银行维度统计数据</li>
    </ul>

    <h3>5.2 管理平台功能</h3>
    
    <h4>5.2.1 用户权限管理</h4>
    <div class="highlight-box">
        <p><strong>分公司业务员：</strong></p>
        <ul>
            <li><strong>角色：</strong>业务运营人员</li>
            <li><strong>权限：</strong>按活动编码分配权限</li>
            <li><strong>功能：</strong>查看和管理对应活动数据</li>
        </ul>
    </div>

    <h4>5.2.2 数据展示</h4>
    <table>
        <tr>
            <th>数据类型</th>
            <th>展示内容</th>
        </tr>
        <tr>
            <td>发放数据展示</td>
            <td>
                • 发放总量统计<br>
                • 发放成功率统计<br>
                • 按时间维度展示发放趋势<br>
                • 按活动维度展示发放分布
            </td>
        </tr>
        <tr>
            <td>核销数据展示</td>
            <td>
                • 核销总量统计<br>
                • 核销率统计<br>
                • 核销金额统计<br>
                • 核销趋势分析
            </td>
        </tr>
        <tr>
            <td>银行数据展示</td>
            <td>
                • 各银行发放量统计<br>
                • 各银行核销率对比<br>
                • 银行活跃度分析
            </td>
        </tr>
    </table>

    <h3>5.3 银行营销平台功能</h3>
    
    <h4>5.3.1 权限控制</h4>
    <ul>
        <li><strong>机构号权限</strong>：按银行机构号分配查询权限</li>
        <li><strong>数据隔离</strong>：银行只能查询自己的相关数据</li>
    </ul>

    <h4>5.3.2 数据查询</h4>
    <ul>
        <li><strong>发放明细查询</strong>：查询本行发放明细</li>
        <li><strong>核销明细查询</strong>：查询本行核销明细</li>
        <li><strong>统计报表查询</strong>：查询本行统计数据</li>
    </ul>

    <h1>6. 接口规范</h1>
    
    <h3>6.1 对外接口（提供给银行）</h3>
    
    <h4>6.1.1 发券接口</h4>
    <div class="api-endpoint">POST /api/coupon/issue</div>
    
    <div class="parameter-list">
        <p><strong>请求参数：</strong></p>
        <ul>
            <li><strong>activityId:</strong> 活动ID</li>
            <li><strong>bankCode:</strong> 银行编码</li>
            <li><strong>userId:</strong> 用户ID</li>
            <li><strong>couponType:</strong> 优惠券类型</li>
            <li><strong>amount:</strong> 优惠金额</li>
            <li><strong>minAmount:</strong> 最小使用金额</li>
        </ul>
    </div>

    <div class="parameter-list">
        <p><strong>响应参数：</strong></p>
        <ul>
            <li><strong>code:</strong> 响应码</li>
            <li><strong>message:</strong> 响应消息</li>
            <li><strong>data:</strong> 发券结果数据</li>
        </ul>
    </div>

    <h4>6.1.2 查询接口</h4>
    <div class="api-endpoint">GET /api/coupon/query</div>
    
    <div class="parameter-list">
        <p><strong>请求参数：</strong></p>
        <ul>
            <li><strong>activityId:</strong> 活动ID</li>
            <li><strong>bankCode:</strong> 银行编码</li>
            <li><strong>startTime:</strong> 开始时间</li>
            <li><strong>endTime:</strong> 结束时间</li>
            <li><strong>pageNum:</strong> 页码</li>
            <li><strong>pageSize:</strong> 页大小</li>
        </ul>
    </div>

    <h3>6.2 回调接口（接收云数惠回调）</h3>
    
    <h4>6.2.1 发放回调接口</h4>
    <div class="api-endpoint">POST /api/callback/issue</div>

    <h4>6.2.2 核销回调接口</h4>
    <div class="api-endpoint">POST /api/callback/redeem</div>

    <h1>7. 数据模型</h1>
    
    <h3>7.1 发放记录表</h3>
    <table>
        <tr>
            <th>字段名</th>
            <th>类型</th>
            <th>说明</th>
        </tr>
        <tr><td>id</td><td>BIGINT</td><td>主键ID</td></tr>
        <tr><td>activityId</td><td>VARCHAR</td><td>活动ID</td></tr>
        <tr><td>bankCode</td><td>VARCHAR</td><td>银行编码</td></tr>
        <tr><td>userId</td><td>VARCHAR</td><td>用户ID</td></tr>
        <tr><td>couponId</td><td>VARCHAR</td><td>优惠券ID</td></tr>
        <tr><td>couponType</td><td>VARCHAR</td><td>优惠券类型</td></tr>
        <tr><td>amount</td><td>DECIMAL</td><td>优惠金额</td></tr>
        <tr><td>status</td><td>INT</td><td>发放状态</td></tr>
        <tr><td>createTime</td><td>DATETIME</td><td>创建时间</td></tr>
        <tr><td>updateTime</td><td>DATETIME</td><td>更新时间</td></tr>
    </table>

    <h3>7.2 核销记录表</h3>
    <table>
        <tr>
            <th>字段名</th>
            <th>类型</th>
            <th>说明</th>
        </tr>
        <tr><td>id</td><td>BIGINT</td><td>主键ID</td></tr>
        <tr><td>couponId</td><td>VARCHAR</td><td>优惠券ID</td></tr>
        <tr><td>activityId</td><td>VARCHAR</td><td>活动ID</td></tr>
        <tr><td>bankCode</td><td>VARCHAR</td><td>银行编码</td></tr>
        <tr><td>userId</td><td>VARCHAR</td><td>用户ID</td></tr>
        <tr><td>redeemAmount</td><td>DECIMAL</td><td>核销金额</td></tr>
        <tr><td>redeemTime</td><td>DATETIME</td><td>核销时间</td></tr>
        <tr><td>status</td><td>INT</td><td>核销状态</td></tr>
    </table>

    <h3>7.3 活动统计表</h3>
    <table>
        <tr>
            <th>字段名</th>
            <th>类型</th>
            <th>说明</th>
        </tr>
        <tr><td>id</td><td>BIGINT</td><td>主键ID</td></tr>
        <tr><td>activityId</td><td>VARCHAR</td><td>活动ID</td></tr>
        <tr><td>bankCode</td><td>VARCHAR</td><td>银行编码</td></tr>
        <tr><td>issueCount</td><td>INT</td><td>发放数量</td></tr>
        <tr><td>issueAmount</td><td>DECIMAL</td><td>发放金额</td></tr>
        <tr><td>redeemCount</td><td>INT</td><td>核销数量</td></tr>
        <tr><td>redeemAmount</td><td>DECIMAL</td><td>核销金额</td></tr>
        <tr><td>statisticsDate</td><td>DATE</td><td>统计日期</td></tr>
    </table>

    <h1>8. 部署要求</h1>
    
    <h3>8.1 环境要求</h3>
    <div class="success-box">
        <ul>
            <li>在现有平台基础上增加功能</li>
            <li>无需独立部署新的技术栈</li>
        </ul>
    </div>

    <h3>8.2 性能要求</h3>
    <table>
        <tr>
            <th>性能指标</th>
            <th>要求</th>
        </tr>
        <tr>
            <td>日发券量支持</td>
            <td>5,000张</td>
        </tr>
        <tr>
            <td>峰值发券量支持</td>
            <td>20,000张/天</td>
        </tr>
        <tr>
            <td>并发银行数</td>
            <td>几十到上百家银行</td>
        </tr>
    </table>

    <h1>9. 安全要求</h1>
    
    <h3>9.1 接口安全</h3>
    <div class="warning-box">
        <ul>
            <li>使用RSA2048加密</li>
            <li>实现接口签名验证</li>
            <li>支持HTTPS协议</li>
        </ul>
    </div>

    <h3>9.2 数据安全</h3>
    <ul>
        <li>敏感数据加密存储</li>
        <li>实现数据访问权限控制</li>
        <li>定期数据备份</li>
    </ul>

    <h1>10. 监控和运维</h1>
    
    <h3>10.1 系统监控</h3>
    <ul>
        <li>接口调用量监控</li>
        <li>接口响应时间监控</li>
        <li>错误率监控</li>
        <li>系统资源监控</li>
    </ul>

    <h3>10.2 业务监控</h3>
    <ul>
        <li>发券成功率监控</li>
        <li>回调处理成功率监控</li>
        <li>数据同步状态监控</li>
    </ul>

    <h1>11. 风险控制</h1>
    
    <h3>11.1 技术风险</h3>
    <div class="warning-box">
        <ul>
            <li>云数惠接口稳定性风险</li>
            <li>高并发处理风险</li>
            <li>数据同步风险</li>
        </ul>
    </div>

    <h3>11.2 业务风险</h3>
    <div class="warning-box">
        <ul>
            <li>发券限额风险</li>
            <li>重复发券风险</li>
            <li>数据一致性风险</li>
        </ul>
    </div>

    <h1>12. 项目计划</h1>
    
    <h3>12.1 开发阶段</h3>
    <table>
        <tr>
            <th>阶段</th>
            <th>工作内容</th>
            <th>预计时间</th>
        </tr>
        <tr>
            <td>需求确认</td>
            <td>确认业务需求和技术方案</td>
            <td>1天</td>
        </tr>
        <tr>
            <td>接口设计</td>
            <td>设计接口和数据库结构</td>
            <td>2天</td>
        </tr>
        <tr>
            <td>开发实现</td>
            <td>功能开发和单元测试</td>
            <td>10天</td>
        </tr>
        <tr>
            <td>联调测试</td>
            <td>与云数惠和银行联调</td>
            <td>3天</td>
        </tr>
        <tr>
            <td>上线部署</td>
            <td>生产环境部署</td>
            <td>1天</td>
        </tr>
    </table>

    <h3>12.2 验收标准</h3>
    <div class="success-box">
        <ul>
            <li>✅ 云数惠接口对接成功</li>
            <li>✅ 银行接口功能正常</li>
            <li>✅ 回调处理机制正常</li>
            <li>✅ 管理平台数据展示正常</li>
            <li>✅ 性能指标达到要求</li>
        </ul>
    </div>

    <div class="footer">
        <p>© 2024 云数惠第三方微信优惠券服务接入项目</p>
        <p>本文档包含项目完整的功能需求、技术规范和实施计划</p>
    </div>
</body>
</html> 