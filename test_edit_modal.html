<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑模态框测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background-color: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }
        .test-button:hover {
            background-color: #337ecc;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #f0f9ff;
            border: 1px solid #67c23a;
            color: #67c23a;
        }
        .error {
            background-color: #fef0f0;
            border: 1px solid #f56c6c;
            color: #f56c6c;
        }
        .info {
            background-color: #f4f4f5;
            border: 1px solid #909399;
            color: #606266;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>编辑模态框功能测试</h1>
        
        <div class="status info">
            <strong>测试说明：</strong>
            <ul>
                <li>点击下面的测试按钮来验证编辑模态框功能</li>
                <li>检查是否还有JavaScript错误</li>
                <li>验证模态框是否能正常显示</li>
                <li>检查选择器功能是否正常工作</li>
            </ul>
        </div>
        
        <button class="test-button" onclick="testEditModal()">测试编辑模态框</button>
        <button class="test-button" onclick="testJavaScriptErrors()">检查JavaScript错误</button>
        <button class="test-button" onclick="openOriginalPage()">打开原始页面</button>
        
        <div id="testResults"></div>
        
        <div class="status info">
            <strong>修复内容：</strong>
            <ul>
                <li>✅ 添加了 editSelectedInstitutions 和 editSelectedBanks 容器元素</li>
                <li>✅ 实现了编辑模态框专用的选择器函数</li>
                <li>✅ 修复了 loadEditData 函数的 null 引用错误</li>
                <li>✅ 修复了编辑按钮点击后模态框立即关闭的问题</li>
                <li>✅ 确保编辑模态框能正常显示和操作</li>
            </ul>
        </div>
    </div>
    
    <script>
        function testEditModal() {
            const resultsDiv = document.getElementById('testResults');
            
            try {
                // 测试是否能访问编辑模态框相关的DOM元素
                const tests = [
                    { name: '编辑模态框元素', test: () => !!document.querySelector('#editActivityModal') },
                    { name: 'editSelectedInstitutions元素', test: () => !!document.querySelector('#editSelectedInstitutions') },
                    { name: 'editSelectedBanks元素', test: () => !!document.querySelector('#editSelectedBanks') },
                    { name: 'showEditActivityModal函数', test: () => typeof showEditActivityModal === 'function' },
                    { name: 'loadEditData函数', test: () => typeof loadEditData === 'function' },
                    { name: 'addSelectedInstitutionEdit函数', test: () => typeof addSelectedInstitutionEdit === 'function' },
                    { name: 'addSelectedBankEdit函数', test: () => typeof addSelectedBankEdit === 'function' }
                ];
                
                let results = '<div class="status success"><h3>测试结果：</h3><ul>';
                let allPassed = true;
                
                tests.forEach(test => {
                    try {
                        const passed = test.test();
                        results += `<li>${test.name}: ${passed ? '✅ 通过' : '❌ 失败'}</li>`;
                        if (!passed) allPassed = false;
                    } catch (e) {
                        results += `<li>${test.name}: ❌ 错误 - ${e.message}</li>`;
                        allPassed = false;
                    }
                });
                
                results += '</ul>';
                if (allPassed) {
                    results += '<p><strong>🎉 所有测试通过！编辑模态框功能已修复。</strong></p>';
                } else {
                    results += '<p><strong>⚠️ 部分测试失败，需要进一步检查。</strong></p>';
                }
                results += '</div>';
                
                resultsDiv.innerHTML = results;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error"><h3>测试失败：</h3><p>${error.message}</p></div>`;
            }
        }
        
        function testJavaScriptErrors() {
            const resultsDiv = document.getElementById('testResults');
            
            // 监听JavaScript错误
            let errorCount = 0;
            const originalError = window.onerror;
            
            window.onerror = function(message, source, lineno, colno, error) {
                errorCount++;
                console.error('JavaScript Error:', { message, source, lineno, colno, error });
                if (originalError) originalError.apply(this, arguments);
            };
            
            // 尝试执行一些可能出错的操作
            try {
                // 模拟调用编辑模态框相关函数
                if (typeof loadEditData === 'function') {
                    loadEditData([], []);
                }
                
                setTimeout(() => {
                    if (errorCount === 0) {
                        resultsDiv.innerHTML = '<div class="status success"><h3>JavaScript错误检查：</h3><p>✅ 未发现JavaScript错误</p></div>';
                    } else {
                        resultsDiv.innerHTML = `<div class="status error"><h3>JavaScript错误检查：</h3><p>❌ 发现 ${errorCount} 个错误，请查看控制台</p></div>`;
                    }
                    
                    // 恢复原始错误处理
                    window.onerror = originalError;
                }, 1000);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error"><h3>JavaScript错误检查：</h3><p>❌ 执行测试时出错：${error.message}</p></div>`;
            }
        }
        
        function openOriginalPage() {
            window.open('activity_prototype.html', '_blank');
        }
        
        // 页面加载时自动运行基本测试
        window.addEventListener('load', function() {
            // 延迟一下确保所有脚本都加载完成
            setTimeout(() => {
                // 检查是否在iframe中（如果是，说明可能在原始页面的上下文中）
                if (window.parent !== window) {
                    testEditModal();
                }
            }, 500);
        });
    </script>
    
    <!-- 加载原始页面的脚本来测试功能 -->
    <iframe src="activity_prototype.html" style="display: none;" onload="setTimeout(testEditModal, 1000)"></iframe>
</body>
</html>