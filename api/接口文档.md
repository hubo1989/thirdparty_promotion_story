## 接入流程

![1754278589901](image/业务概述/1754278589901.png)

## **接口列表**

1. 获取 openid
2. 发放优惠券
3. 核销回调
4. 数据查询

## 接口详细描述

## 1. 获取 openid

在券列表或详情页嵌入该 H5 链接，用于获取用户的 openid，以便进行后续的业务操作。

**接入方式：**

- 嵌入H5

**测试环境地址：**

```
https://bmk-market.dshytest.com/deliverWM/1017578611540230144?wmcb=xxx
```

**生产环境地址：**

```
https://market.dsaika.com/deliverWM/1019393703635943424?wmcb=xxx
```

**回调请求方式：** GET

**回调参数：** `${redirect_url}&openid=${response.data.openId}&from=dshy`

**请求示例：**

```
GET /callback?redirect_url=https:\\Fexample.com&openid=oRvltwHjF4p7g5j3h2k1j0i9h8g7&from=dshy HTTP/1.1
Host: your-domain.com
```

**返回示例：**

```
HTTP/1.1 200 OK
Content-Type: application/json
```json
{
  "status": "success",
  "msg": "OpenID retrieved successfully",
  "data": {
    "openid": "oRvltwHjF4p7g5j3h2k1j0i9h8g7",
    "from": "dshy"
  }
}
```

## 2. 发放优惠券

### 请求URL

测试环境：[https://test.wsmsd.cn/sit/api/...](https://test.wsmsd.cn/sit/api)

生产环境：

### 请求接口说明(req_data)

| 字段名称           | 内容              | 是否必输 | 最大长度          | 示例值                          |
| -------------- | --------------- | ---- | ------------- | ---------------------------- |
| member_id      | 会员号             | M    | String(10-20) | AAA200154561278（拉卡拉提供前缀信息）   |
| activity_id    | 活动号             | M    | String(10)    | 1100000086（拉卡拉提供）            |
| owner_id       | 业主Id            | M    | String(8)     | 80000007（拉卡拉提供）              |
| promotion_id   | 优惠Id            | M    | String(32)    | WX1623452352312523523（拉卡拉提供） |
| channel_openid | 接口1中获取到的 openid | M    | String(128)   | oKL-mwRzR-SBfI4QDAI1QXOpkyc8 |
| mer_order_id   | 商户订单号           | M    | String(64)    | 20211203092301               |
| writeOffNotify | 核销事件通知地址        | M    | Sting(256)    | https://test.bank.com/notif  |
| postNotify     | 发放回调地址          | M    | String(256)   | https://test.bank.com/postNotify |

### 响应(resp_data)

| 字段名称              | 内容                     | 是否必输 | 示例值                                       |
| ----------------- | ---------------------- | ---- | ----------------------------------------- |
| msg               | 响应信息                   | M    | 处理成功                                      |
| code              | 响应码                    | M    | 000000                                    |
| data              | 响应数据                   | O    | 详见以下参数                                    |
| 以下为 data 参数有值时的内容 |                        |      |                                           |
| resCode           | 接口请求是否成功,业务码000000代表成功 | M    | 000000                                    |
| failMsg           | 失败信息业务码不为 000000 时传输   | M    | 系统异常                                      |
| activity_id       | 活动号                    | M    | 1100000086                                |
| owner_id          | 业主Id                   | M    | 80000007                                  |
| promotion_id      | 优惠Id                   | M    | WX1623452352312523523                     |
| third_coupon_id   | 第三方券ID                 | M    | wxd596543989121024                        |
| mer_order_id      | 商户订单号                  | M    | 接入方唯一                                     |
| trade_no          | 平台订单号                  | M    | 唯一                                        |
| batch_code        | 微信活动批次号                | M    | 1623452352312                             |
| channel_openid    | 用户openid               | M    | oKL-mwRzR-SBfI4QDAI1QXOpkyc8              |
| trade_status      | 发放结果                   | M    | PROCESS：处理中<br />SUCCESS：成功 <br />FAIL：失败 |

### 示例

**请求示例：**

```json
{
  "member_id": "AAA200154561278",
  "activity_id": "1100000086",
  "owner_id": "80000007",
  "promotion_id": "WX1623452352312523523",
  "channel_openid": "oKL-mwRzR-SBfI4QDAI1QXOpkyc8",
  "mer_order_id": "20211203092301",
  "writeOffNotify": "https://test.bank.com/notif"
}
```

**返回示例：**

```json
{
  "msg": "处理成功",
  "code": "000000",
  "data": {
    "resCode": "000000",
    "failMsg": "",
    "activity_id": "1100000086",
    "owner_id": "80000007",
    "promotion_id": "WX1623452352312523523",
    "third_coupon_id": "wxd596543989121024",
    "mer_order_id": "20211203092301",
    "trade_no": "202112030923010001",
    "batch_code": "1254325364564365",
    "channel_openid": "oKL-mwRzR-SBfI4QDAI1QXOpkyc8",
    "trade_status": "SUCCESS"
  }
}
```

**失败返回示例：**

```json
{
  "msg": "系统异常",
  "code": "999999",
  "data": {
    "resCode": "999999",
    "failMsg": "系统异常",
    "activity_id": "",
    "owner_id": "",
    "promotion_id": "",
    "third_coupon_id": "",
    "mer_order_id": "",
    "trade_no": "",
    "openId": "",
    "trade_status": ""
  }
}
```

## 3. 发放回调

> 通知接入方系统优惠券发放结果，通过延时队列进行散列通知，通知频率：间隔：1s/5s/5s/10s/3m/10m/20m/30m/1h/2h - 总计 4h3m21s。商户返回应答SUCCESS，将终止通知

### Header中传送下列值

Authorization: 认证类型 签名信息 如

Authorization: "LKLAPI-SHA256withRSA timestamp=\"${timeStamp}\",nonce_str=\"${nonceStr}\",signature=\"${signature}\""

其中 LKLAPI-SHA256withRSA 表示拉卡拉安全接入签名加密方式

| 名称        | 描述          |
| --------- | ----------- |
| timestamp | 发起的系统时间（秒）  |
| nonce_str | 12个字符的随机字符串 |
| signature | 签名          |

### 通知报文参数

| 字段名称            | 约束  | 字段类型   | 长度  | 字段描述         | 取值说明                                 |
| --------------- | --- | ------ | --- | ------------ | ------------------------------------ |
| orgId           | 是  | String |  | 机构唯一标识      |                                      |
| callTradeNo     | 是  | String |  | 平台交易号        |                                      |
| amount          | 是  | String |  | 优惠金额，单位：元  |                                      |
| tradeStatus     | 是  | String |  | 核销状态         | SUCCESS：成功<br />FAIL：失败            |
| failMsg         | 否  | String |  | 失败原因         |                                      |
| tradeCreateTime | 是  | String |  | 交易创建时间       |                                      |
| tradePaymentTime| 是  | String |  | 发放成功时间       |                                      |
| signType        | 是  | String |  | 签名类型         | RSA2                                 |
| sign            | 是  | String |  | 签名           |                                      |

### 响应报文参数

| 字段名称 | 约束  | 字段类型   | 长度  | 字段描述 | 取值说明                    |
| ---- | --- | ------ | --- | ---- | ----------------------- |
| code | 必返  | String | 32  | 应答码  | SUCCESS:成功<br />FAIL:失败 |
| msg  | 必返  | String | 64  | 异常信息 | 异常信息内容                  |

### 示例

**请求示例：**

```json
{
  "orgId": "86802221ca93cd",
  "callTradeNo": "20231025142512623545",
  "amount": "1.00",
  "tradeStatus": "SUCCESS",
  "failMsg": "",
  "tradeCreateTime": "2023-10-25 14:24:18",
  "tradePaymentTime": "2023-10-25 14:24:19",
  "signType": "RSA2",
  "sign": "YHTsRk8rgecdef6Nrj72eeJfdeFPlVgTt9zQEE4sJ5qcJpt1af7szkFwe7r6f7Gj8eiGVQCx9PwHu9PYj8Y1J4v0s1qJmG7v6J4k8rj1vJde7ucxUDk9yY7ggPYbcYXvs1QoawbIVhcA3XGf"
}
```

**返回示例：**

```json
{
  "code": "SUCCESS",
  "msg": "处理成功"
}
```

**失败返回示例：**

```json
{
  "code": "FAIL",
  "msg": "处理失败"
}

## 4. 核销回调

> 通知接入方系统，通过延时队列进行散列通知，通知频率：间隔：1s/5s/5s/10s/3m/10m/20m/30m/1h/2h - 总计 4h3m21s。商户返回应答SUCCESS，将终止通知

### Header中传送下列值

Authorization: 认证类型 签名信息 如

Authorization: “LKLAPI-SHA256withRSA timestamp=”${timeStamp}”,nonce_str=”${nonceStr}”,signature=”${signature}”“

其中 LKLAPI-SHA256withRSA 表示拉卡拉安全接入签名加密方式

| 名称        | 描述          |
| --------- | ----------- |
| timestamp | 发起的系统时间（秒）  |
| nonce_str | 12个字符的随机字符串 |
| signature | 签名          |

### 通知报文参数

| 字段名称            | 约束  | 字段类型   | 长度  | 字段描述         | 取值说明                                 |
| --------------- | --- | ------ | --- | ------------ | ------------------------------------ |
| member_id       | M   | String | 12  | 会员ID         | AAA200154561278（拉卡拉提供前缀信息）           |
| owner_id        | M   | String | 8   | 业主ID         | 80000007                             |
| channel_openid  | M   | Object | 128 | 微信openID     | oKL-mwRzR-SBfI4QDAI1QXOpkyc8         |
| promotion_id    | M   | String | 32  | 优惠ID         | WX1623452352312523523                |
| third_coupon_id | M   | String | 128 | 第三方券Id       | wxd596543989121024                   |
| activity_id     | M   | String | 32  | 活动号          | 1100000086                           |
| promo_amount    | O   | String | 20  | 优惠金额,单位：分    | 可能为空                                 |
| total_amount    | O   | String | 20  | 订单优惠后金额,单位：分 | 可能为空                                 |
| org_amount      | O   | String | 20  | 原订单金额,单位：分   | 可能为空                                 |
| trade_no        | M   | String | 64  | 平台订单号        | 全局唯一                                 |
| mer_order_id    | M   | String | 64  | 商户订单号        | 渠道方唯一                                |
| gmt_used        | O   | String | 19  | 核销时间         | 格式：YYYY-MM-DD HH:MM:SS               |
| tradeStatus     | M   | String | 19  | 核销时间         | 核销状态：<br />USED：已实扣<br />EXPIRED：已过期 |

### 响应报文参数

| 字段名称 | 约束  | 字段类型   | 长度  | 字段描述 | 取值说明                    |
| ---- | --- | ------ | --- | ---- | ----------------------- |
| code | 必返  | String | 32  | 应答码  | SUCCESS:成功<br />FAIL:失败 |
| msg  | 必返  | String | 64  | 异常信息 | 异常信息内容                  |

### 示例

**请求示例：**

```json
{
  "member_id": "AAA200154561278",
  "owner_id": "80000007",
  "channel_openid": "oKL-mwRzR-SBfI4QDAI1QXOpkyc8",
  "promotion_id": "WX1623452352312523523",
  "third_coupon_id": "wxd596543989121024",
  "activity_id": "1100000086",
  "promo_amount": "1000",
  "total_amount": "9000",
  "org_amount": "10000",
  "trade_no": "202112030923010001",
  "mer_order_id": "20211203092301",
  "gmt_used": "2021-12-03 10:30:00",
  "tradeStatus": "USED"
}
```

**返回示例：**

```json
{
  "code": "SUCCESS",
  "msg": "处理成功"
}
```

**失败返回示例：**

```json
{
  "code": "FAIL",
  "msg": "处理失败"
}
```

## 5. 数据查询

用于查询发券结果和核销结果。

#### 请求参数

| 字段名称         | 内容    | 是否必输 | 最大长度       | 示例值                |
| ------------ | ----- | ---- | ---------- | ------------------ |
| owner_id     | 业主Id  | M    | String(8)  | 80000007           |
| mer_order_id | 商户订单号 | M    | String(64) | 20211203092301     |
| activity_id  | 活动号   | M    | String(32) | 1100000086         |
| trade_no     | 平台订单号 | M    | String(64) | 202112030923010001 |

#### 响应参数

| 字段名称              | 内容           | 是否必输 | 备注                                       |
| ----------------- | ------------ | ---- | ---------------------------------------- |
| msg               | 响应信息         | M    | 处理成功                                     |
| code              | 响应码          | M    | 000000                                   |
| data              | 响应数据         | O    | 详见以下参数                                   |
| 以下为 data 参数有值时的内容 |              |      |                                          |
| resCode           | 接口请求是否成功     | M    | 000000: 成功<br />其他: 失败                   |
| failMsg           | 失败信息         | M    | 当resCode不为000000时返回                      |
| trade_status      | 发放结果         | M    | PROCESS：处理中<br />SUCCESS：成功<br />FAIL：失败 |
| promo_amount      | 优惠金额,单位：分    | O    | 允许为空                                     |
| total_amount      | 订单优惠后金额,单位：分 | O    | 允许为空                                     |
| org_amount        | 原订单金额,单位：分   | O    | 允许为空                                     |
| gmt_used          | 核销时间         | O    | 格式：YYYY-MM-DD HH:MM:SS                   |
| tradeStatus       | 核销状态         | O    | USED：已实扣<br />EXPIRED：已过期                |

**请求示例：**

```json
{
  "owner_id": "80000007",
  "mer_order_id": "20211203092301",
  "activity_id": "1100000086",
  "trade_no": "202112030923010001"
}
```

**返回示例：**

```json
{
  "msg": "处理成功",
  "code": "000000",
  "data": {
    "resCode": "000000",
    "failMsg": "",
    "trade_status": "SUCCESS",
    "promo_amount": "1000",
    "total_amount": "9000",
    "org_amount": "10000",
    "gmt_used": "2021-12-03 10:30:00",
    "tradeStatus": "USED"
  }
}
```

**失败返回示例：**

```json
{
  "msg": "系统异常",
  "code": "999999",
  "data": {
    "resCode": "999999",
    "failMsg": "系统异常",
    "trade_status": "",
    "promo_amount": "",
    "total_amount": "",
    "org_amount": "",
    "gmt_used": "",
    "tradeStatus": ""
  }
}
```
